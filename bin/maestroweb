#!/usr/bin/env ruby

$: << File.expand_path(File.join(File.dirname(__FILE__), '..', "lib"))
$: << File.expand_path(File.join(File.dirname(__FILE__), '..', "web"))
require "rubygems"
require "bundler/setup"

require 'eventmachine'
require 'sinatra/async'

require 'maestro_web'
require 'progenitor/udp_broadcaster'
require 'progenitor/asset_deployer'

BROADCAST_PORT = 8833
LISTEN_PORT = 8833

RSA_PRIVATE_KEY = File.expand_path(File.join(File.dirname(__FILE__), "..", ".ssh", "maestro-key"))
ASSETS_LOCATION = File.expand_path(File.join(File.dirname(__FILE__), "..", "sample-assets"))

server = Progenitor::MaestroServer.new(LISTEN_PORT)
broadcaster = Progenitor::UdpBroadcaster.new(BROADCAST_PORT, LISTEN_PORT)
deployer = Progenitor::AssetDeployer.new( RSA_PRIVATE_KEY, ASSETS_LOCATION )

EM::run do
  server.start
  MaestroApp.asset_deployer = deployer
  MaestroApp.broadcast_port = BROADCAST_PORT
  MaestroApp.run!

  EventMachine.add_periodic_timer(5) do
    broadcaster.go
  end
end

