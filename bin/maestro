#!/usr/bin/env ruby

$: << File.expand_path(File.join(File.dirname(__FILE__), "..", "lib"))

require 'eventmachine'
require 'progenitor/maestro_server'
require 'progenitor/udp_broadcaster'

PORT = 8833
server = Progenitor::MaestroServer.new(PORT)
broadcaster = Progenitor::UdpBroadcaster.new(PORT)

Progenitor::Orchestra.instance.on_play do |name, event, player_id|
  puts "Playing #{name} #{event} from #{player_id}"
end

Progenitor::Orchestra.instance.on_register do |player, hears, plays|
  puts "Register #{player.spalla_id}"
end

Progenitor::Orchestra.instance.on_unregister do |spalla_id|
  puts "Spalla disconnected: #{spalla_id}"
end

EM::run do
  server.start

  EventMachine.add_periodic_timer(5) do
    broadcaster.go
  end
end

